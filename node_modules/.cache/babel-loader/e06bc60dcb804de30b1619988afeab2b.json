{"ast":null,"code":"var __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __spreadArrays = this && this.__spreadArrays || function () {\n  for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n\n  for (var r = Array(s), k = 0, i = 0; i < il; i++) for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++) r[k] = a[j];\n\n  return r;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar state_1 = require(\"../state\");\n\nvar query_1 = require(\"../query/\");\n\nvar FilterBasedAccessor_1 = require(\"./FilterBasedAccessor\");\n\nvar map = require('lodash/map');\n\nvar each = require('lodash/each');\n\nvar compact = require('lodash/compact');\n\nvar take = require('lodash/take');\n\nvar omitBy = require('lodash/omitBy');\n\nvar isUndefined = require('lodash/isUndefined');\n\nvar HierarchicalFacetAccessor =\n/** @class */\nfunction (_super) {\n  __extends(HierarchicalFacetAccessor, _super);\n\n  function HierarchicalFacetAccessor(key, options) {\n    var _this = _super.call(this, key) || this;\n\n    _this.state = new state_1.LevelState();\n    _this.options = options;\n\n    _this.computeUuids();\n\n    return _this;\n  }\n\n  HierarchicalFacetAccessor.prototype.computeUuids = function () {\n    var _this = this;\n\n    this.uuids = map(this.options.fields, function (field) {\n      return _this.uuid + field;\n    });\n  };\n\n  HierarchicalFacetAccessor.prototype.onResetFilters = function () {\n    this.resetState();\n  };\n\n  HierarchicalFacetAccessor.prototype.getBuckets = function (level) {\n    var field = this.options.fields[level];\n    var buckets = this.getAggregations([this.options.id, field, field, 'buckets'], []);\n    return map(buckets, function (item) {\n      item.key = String(item.key);\n      return item;\n    });\n  };\n\n  HierarchicalFacetAccessor.prototype.getOrder = function () {\n    var _a;\n\n    if (this.options.orderKey) {\n      var orderDirection = this.options.orderDirection || 'asc';\n      return _a = {}, _a[this.options.orderKey] = orderDirection, _a;\n    }\n  };\n\n  HierarchicalFacetAccessor.prototype.buildSharedQuery = function (query) {\n    var _this = this;\n\n    each(this.options.fields, function (field, i) {\n      var filters = _this.state.getLevel(i);\n\n      var parentFilter = _this.state.getLevel(i - 1);\n\n      var isLeaf = !_this.state.levelHasFilters(i + 1);\n      var filterTerms = map(filters, query_1.TermQuery.bind(null, field));\n\n      if (filterTerms.length > 0) {\n        query = query.addFilter(_this.uuids[i], filterTerms.length > 1 ? query_1.BoolShould(filterTerms) : filterTerms[0]);\n      }\n\n      if (isLeaf) {\n        var selectedFilters = map(filters, function (filter) {\n          return {\n            id: _this.options.id,\n            name: _this.translate(parentFilter[0]) || _this.options.title || _this.translate(field),\n            value: _this.translate(filter),\n            remove: function () {\n              _this.state = _this.state.remove(i, filter);\n            }\n          };\n        });\n        query = query.addSelectedFilters(selectedFilters);\n      }\n    });\n    return query;\n  };\n\n  HierarchicalFacetAccessor.prototype.buildOwnQuery = function (query) {\n    var _this = this;\n\n    var lvlAggs = compact(map(this.options.fields, function (field, i) {\n      if (_this.state.levelHasFilters(i - 1) || i == 0) {\n        return query_1.FilterBucket(field, query.getFiltersWithKeys(take(_this.uuids, i)), query_1.TermsBucket(field, field, omitBy({\n          size: _this.options.size,\n          order: _this.getOrder()\n        }, isUndefined)));\n      }\n    }));\n    var aggs = query_1.FilterBucket.apply(void 0, __spreadArrays([this.options.id, query.getFiltersWithoutKeys(this.uuids)], lvlAggs));\n    return query.setAggs(aggs);\n  };\n\n  return HierarchicalFacetAccessor;\n}(FilterBasedAccessor_1.FilterBasedAccessor);\n\nexports.HierarchicalFacetAccessor = HierarchicalFacetAccessor;","map":{"version":3,"sources":["../../../src/core/accessors/HierarchicalFacetAccessor.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["var __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __spreadArrays = (this && this.__spreadArrays) || function () {\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\n            r[k] = a[j];\n    return r;\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar state_1 = require(\"../state\");\nvar query_1 = require(\"../query/\");\nvar FilterBasedAccessor_1 = require(\"./FilterBasedAccessor\");\nvar map = require('lodash/map');\nvar each = require('lodash/each');\nvar compact = require('lodash/compact');\nvar take = require('lodash/take');\nvar omitBy = require('lodash/omitBy');\nvar isUndefined = require('lodash/isUndefined');\nvar HierarchicalFacetAccessor = /** @class */ (function (_super) {\n    __extends(HierarchicalFacetAccessor, _super);\n    function HierarchicalFacetAccessor(key, options) {\n        var _this = _super.call(this, key) || this;\n        _this.state = new state_1.LevelState();\n        _this.options = options;\n        _this.computeUuids();\n        return _this;\n    }\n    HierarchicalFacetAccessor.prototype.computeUuids = function () {\n        var _this = this;\n        this.uuids = map(this.options.fields, function (field) { return _this.uuid + field; });\n    };\n    HierarchicalFacetAccessor.prototype.onResetFilters = function () {\n        this.resetState();\n    };\n    HierarchicalFacetAccessor.prototype.getBuckets = function (level) {\n        var field = this.options.fields[level];\n        var buckets = this.getAggregations([this.options.id, field, field, 'buckets'], []);\n        return map(buckets, function (item) {\n            item.key = String(item.key);\n            return item;\n        });\n    };\n    HierarchicalFacetAccessor.prototype.getOrder = function () {\n        var _a;\n        if (this.options.orderKey) {\n            var orderDirection = this.options.orderDirection || 'asc';\n            return _a = {}, _a[this.options.orderKey] = orderDirection, _a;\n        }\n    };\n    HierarchicalFacetAccessor.prototype.buildSharedQuery = function (query) {\n        var _this = this;\n        each(this.options.fields, function (field, i) {\n            var filters = _this.state.getLevel(i);\n            var parentFilter = _this.state.getLevel(i - 1);\n            var isLeaf = !_this.state.levelHasFilters(i + 1);\n            var filterTerms = map(filters, query_1.TermQuery.bind(null, field));\n            if (filterTerms.length > 0) {\n                query = query.addFilter(_this.uuids[i], filterTerms.length > 1 ? query_1.BoolShould(filterTerms) : filterTerms[0]);\n            }\n            if (isLeaf) {\n                var selectedFilters = map(filters, function (filter) { return ({\n                    id: _this.options.id,\n                    name: _this.translate(parentFilter[0]) || _this.options.title || _this.translate(field),\n                    value: _this.translate(filter),\n                    remove: function () {\n                        _this.state = _this.state.remove(i, filter);\n                    }\n                }); });\n                query = query.addSelectedFilters(selectedFilters);\n            }\n        });\n        return query;\n    };\n    HierarchicalFacetAccessor.prototype.buildOwnQuery = function (query) {\n        var _this = this;\n        var lvlAggs = compact(map(this.options.fields, function (field, i) {\n            if (_this.state.levelHasFilters(i - 1) || i == 0) {\n                return query_1.FilterBucket(field, query.getFiltersWithKeys(take(_this.uuids, i)), query_1.TermsBucket(field, field, omitBy({\n                    size: _this.options.size,\n                    order: _this.getOrder()\n                }, isUndefined)));\n            }\n        }));\n        var aggs = query_1.FilterBucket.apply(void 0, __spreadArrays([this.options.id, query.getFiltersWithoutKeys(this.uuids)], lvlAggs));\n        return query.setAggs(aggs);\n    };\n    return HierarchicalFacetAccessor;\n}(FilterBasedAccessor_1.FilterBasedAccessor));\nexports.HierarchicalFacetAccessor = HierarchicalFacetAccessor;\n//# sourceMappingURL=HierarchicalFacetAccessor.js.map"]},"metadata":{},"sourceType":"script"}