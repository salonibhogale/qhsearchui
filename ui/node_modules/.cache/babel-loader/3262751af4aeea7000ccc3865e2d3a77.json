{"ast":null,"code":"var __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __spreadArrays = this && this.__spreadArrays || function () {\n  for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n\n  for (var r = Array(s), k = 0, i = 0; i < il; i++) for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++) r[k] = a[j];\n\n  return r;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar state_1 = require(\"../state\");\n\nvar query_1 = require(\"../query\");\n\nvar FilterBasedAccessor_1 = require(\"./FilterBasedAccessor\");\n\nvar map = require('lodash/map');\n\nvar get = require('lodash/get');\n\nvar includes = require('lodash/includes');\n\nvar startsWith = require('lodash/startsWith');\n\nvar each = require('lodash/each');\n\nvar take = require('lodash/take');\n\nvar NestedFacetAccessor =\n/** @class */\nfunction (_super) {\n  __extends(NestedFacetAccessor, _super);\n\n  function NestedFacetAccessor(key, options) {\n    var _this = _super.call(this, key, options.id) || this;\n\n    _this.state = new state_1.LevelState();\n    _this.options = options;\n    return _this;\n  }\n\n  NestedFacetAccessor.prototype.onResetFilters = function () {\n    this.resetState();\n  };\n\n  NestedFacetAccessor.prototype.getBuckets = function (level) {\n    var buckets = this.getAggregations([this.key, 'children', 'lvl' + level, 'children', 'buckets'], []);\n    return map(buckets, function (item) {\n      item.key = String(item.key);\n      return item;\n    });\n  };\n\n  NestedFacetAccessor.prototype.buildSharedQuery = function (query) {\n    var _this = this;\n\n    var levelFilters = this.state.getValue();\n    var lastIndex = levelFilters.length - 1;\n    var filterTerms = map(levelFilters, function (filter, i) {\n      var value = filter[0];\n      var isLeaf = i === lastIndex;\n      var subField = isLeaf ? '.value' : '.ancestors';\n      return query_1.TermQuery(_this.options.field + subField, value);\n    });\n\n    if (filterTerms.length > 0) {\n      var leafFilter = get(levelFilters, [levelFilters.length - 1, 0], '');\n      var parentOfleaf = get(levelFilters, [levelFilters.length - 2, 0], this.options.title || this.key);\n      var selectedFilter = {\n        id: this.key,\n        name: this.translate(parentOfleaf),\n        value: leafFilter,\n        remove: function () {\n          _this.state = _this.state.clear(levelFilters.length - 1);\n        }\n      };\n      query = query.addFilter(this.uuid, query_1.NestedQuery(this.options.field, query_1.BoolMust(filterTerms))).addSelectedFilter(selectedFilter);\n    }\n\n    return query;\n  };\n\n  NestedFacetAccessor.prototype.getTermAggs = function () {\n    var _a, _b;\n\n    var subAggs = undefined;\n    var orderMetric = undefined;\n\n    if (this.options.orderKey) {\n      var orderDirection = this.options.orderDirection || 'asc';\n      var orderKey = this.options.orderKey;\n\n      if (includes(['_count', '_term'], orderKey)) {\n        orderMetric = (_a = {}, _a[orderKey] = orderDirection, _a);\n      } else {\n        if (startsWith(orderKey, this.options.field + '.')) {\n          var subAggName = this.options.field + '_order';\n          orderMetric = (_b = {}, _b[subAggName] = orderDirection, _b);\n          subAggs = query_1.MinMetric(subAggName, orderKey);\n        }\n      }\n    }\n\n    var valueField = this.options.field + '.value';\n    var nBuckets = this.options.size || query_1.DefaultNumberBuckets;\n    return query_1.TermsBucket('children', valueField, {\n      size: nBuckets,\n      order: orderMetric\n    }, subAggs);\n  };\n\n  NestedFacetAccessor.prototype.buildOwnQuery = function (query) {\n    var levelField = this.options.field + '.level';\n    var ancestorsField = this.options.field + '.ancestors';\n    var startLevel = this.options.startLevel || 1;\n    var termAggs = this.getTermAggs();\n    var lvlAggs = [];\n\n    var addLevel = function (level, ancestors) {\n      if (ancestors === void 0) {\n        ancestors = [];\n      }\n\n      lvlAggs.push(query_1.FilterBucket('lvl' + level, query_1.BoolMust(__spreadArrays([query_1.TermQuery(levelField, level + startLevel)], ancestors)), termAggs));\n    };\n\n    addLevel(0);\n    var levels = this.state.getValue();\n    each(levels, function (_level, i) {\n      var ancestors = map(take(levels, i + 1), function (level) {\n        return query_1.TermQuery(ancestorsField, level[0]);\n      });\n      addLevel(i + 1, ancestors);\n    });\n    return query.setAggs(query_1.FilterBucket(this.key, query.getFiltersWithoutKeys(this.uuid), query_1.NestedBucket.apply(void 0, __spreadArrays(['children', this.options.field], lvlAggs))));\n  };\n\n  return NestedFacetAccessor;\n}(FilterBasedAccessor_1.FilterBasedAccessor);\n\nexports.NestedFacetAccessor = NestedFacetAccessor;","map":{"version":3,"sources":["../../../src/core/accessors/NestedFacetAccessor.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["var __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __spreadArrays = (this && this.__spreadArrays) || function () {\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\n            r[k] = a[j];\n    return r;\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar state_1 = require(\"../state\");\nvar query_1 = require(\"../query\");\nvar FilterBasedAccessor_1 = require(\"./FilterBasedAccessor\");\nvar map = require('lodash/map');\nvar get = require('lodash/get');\nvar includes = require('lodash/includes');\nvar startsWith = require('lodash/startsWith');\nvar each = require('lodash/each');\nvar take = require('lodash/take');\nvar NestedFacetAccessor = /** @class */ (function (_super) {\n    __extends(NestedFacetAccessor, _super);\n    function NestedFacetAccessor(key, options) {\n        var _this = _super.call(this, key, options.id) || this;\n        _this.state = new state_1.LevelState();\n        _this.options = options;\n        return _this;\n    }\n    NestedFacetAccessor.prototype.onResetFilters = function () {\n        this.resetState();\n    };\n    NestedFacetAccessor.prototype.getBuckets = function (level) {\n        var buckets = this.getAggregations([this.key, 'children', 'lvl' + level, 'children', 'buckets'], []);\n        return map(buckets, function (item) {\n            item.key = String(item.key);\n            return item;\n        });\n    };\n    NestedFacetAccessor.prototype.buildSharedQuery = function (query) {\n        var _this = this;\n        var levelFilters = this.state.getValue();\n        var lastIndex = levelFilters.length - 1;\n        var filterTerms = map(levelFilters, function (filter, i) {\n            var value = filter[0];\n            var isLeaf = i === lastIndex;\n            var subField = isLeaf ? '.value' : '.ancestors';\n            return query_1.TermQuery(_this.options.field + subField, value);\n        });\n        if (filterTerms.length > 0) {\n            var leafFilter = get(levelFilters, [levelFilters.length - 1, 0], '');\n            var parentOfleaf = get(levelFilters, [levelFilters.length - 2, 0], this.options.title || this.key);\n            var selectedFilter = {\n                id: this.key,\n                name: this.translate(parentOfleaf),\n                value: leafFilter,\n                remove: function () {\n                    _this.state = _this.state.clear(levelFilters.length - 1);\n                }\n            };\n            query = query\n                .addFilter(this.uuid, query_1.NestedQuery(this.options.field, query_1.BoolMust(filterTerms)))\n                .addSelectedFilter(selectedFilter);\n        }\n        return query;\n    };\n    NestedFacetAccessor.prototype.getTermAggs = function () {\n        var _a, _b;\n        var subAggs = undefined;\n        var orderMetric = undefined;\n        if (this.options.orderKey) {\n            var orderDirection = this.options.orderDirection || 'asc';\n            var orderKey = this.options.orderKey;\n            if (includes(['_count', '_term'], orderKey)) {\n                orderMetric = (_a = {}, _a[orderKey] = orderDirection, _a);\n            }\n            else {\n                if (startsWith(orderKey, this.options.field + '.')) {\n                    var subAggName = this.options.field + '_order';\n                    orderMetric = (_b = {},\n                        _b[subAggName] = orderDirection,\n                        _b);\n                    subAggs = query_1.MinMetric(subAggName, orderKey);\n                }\n            }\n        }\n        var valueField = this.options.field + '.value';\n        var nBuckets = this.options.size || query_1.DefaultNumberBuckets;\n        return query_1.TermsBucket('children', valueField, { size: nBuckets, order: orderMetric }, subAggs);\n    };\n    NestedFacetAccessor.prototype.buildOwnQuery = function (query) {\n        var levelField = this.options.field + '.level';\n        var ancestorsField = this.options.field + '.ancestors';\n        var startLevel = this.options.startLevel || 1;\n        var termAggs = this.getTermAggs();\n        var lvlAggs = [];\n        var addLevel = function (level, ancestors) {\n            if (ancestors === void 0) { ancestors = []; }\n            lvlAggs.push(query_1.FilterBucket('lvl' + level, query_1.BoolMust(__spreadArrays([query_1.TermQuery(levelField, level + startLevel)], ancestors)), termAggs));\n        };\n        addLevel(0);\n        var levels = this.state.getValue();\n        each(levels, function (_level, i) {\n            var ancestors = map(take(levels, i + 1), function (level) { return query_1.TermQuery(ancestorsField, level[0]); });\n            addLevel(i + 1, ancestors);\n        });\n        return query.setAggs(query_1.FilterBucket(this.key, query.getFiltersWithoutKeys(this.uuid), query_1.NestedBucket.apply(void 0, __spreadArrays(['children', this.options.field], lvlAggs))));\n    };\n    return NestedFacetAccessor;\n}(FilterBasedAccessor_1.FilterBasedAccessor));\nexports.NestedFacetAccessor = NestedFacetAccessor;\n//# sourceMappingURL=NestedFacetAccessor.js.map"]},"metadata":{},"sourceType":"script"}